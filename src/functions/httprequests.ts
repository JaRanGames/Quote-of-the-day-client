/**
 * Perform a http request 
 * to a remote API 
 */

/*
example request
http({
    url: http://example.com
    method: "POST",
    headers: { "" }
})
*/

import queryString from "querystring"

interface HttpReturnType {
    status: number,
    url: string,
    ok: string,
    [key: string]: any
}

export default function http(data: any): Promise<HttpReturnType> {
	return new Promise(async resolve => {
		let bearer = undefined
		if (data.auth !== undefined)
			bearer = { "Authorization": "Bearer " + data.auth }

		const headers = new Headers({
			"Content-Type": "application/x-www-form-urlencoded",
			...bearer,
			...data.headers
		})
		const form = new FormData()

		for (const key in data.data) {
			if (data.data.hasOwnProperty(key)) {
				form.append(key, data.data[key])
			}
		}
		const payload: RequestInit = {
			method: data.method,
			headers: headers,
			mode: "cors",
			credentials: "same-origin"
		}
		if (data.method !== "GET")
			payload.body = queryString.stringify(data.data)
		else {
			data.url += "?" + queryString.stringify(data.data)
			delete payload.body
		}

		const result = await fetch(data.url, payload)

		let parsed = undefined
		try {
			parsed = await result.json()
		} catch (error) {
			parsed = result
		}

		resolve({ status: result.status, url: result.url, ok: result.ok, ...parsed})
	})
}